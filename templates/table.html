<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Таблица отделов</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>

<body>
    <p>
        {% if user.username != 'Guest' %}
        Привет, {{ user.username }} |
        {% endif %}
        {% if user.username == 'Guest' %}
        <a href='/login_form'>Войти</a>
        {% else %}
        <a href='/logout'>Выйти</a>
        {% endif %}
    </p>

    <div class="table-container tableFixHead">
        <table>
            <colgroup>
                <col class="col-first">
                {% for metric in metrics %}
                <col class="col-small">
                {% endfor %}
                {% if user.id == 1 %}
                <col class="col-small">
                {% endif %}
            </colgroup>

            <thead>
                <tr>
                    <th>Отдел ОГКУ "ТО МФЦ"</th>
                    {% for metric in metrics %}
                    <th>
                        {% if metric.name|length > 15 and user.id == 1 %}
                        <span class="short-text">{{ metric.name[:15] }}...</span>
                        <span class="full-text" style="display:none;">{{ metric.name }}</span>
                        <span class="toggle-button" onclick="toggleText(this)">Показать</span>
                        {% else %}
                        {{ metric.name }}
                        {% endif %}

                        {% if user.id in (1, 2) %}
                        <form method="post" action="/update_metric_id/{{ metric.id }}"
                            style="display:inline-block; margin-left:5px;">
                            <input type="number" name="new_id" value="{{ metric.id }}" style="width:50px;">
                            <input type="submit" value="Сохранить" class="table-btn">
                        </form>
                        {% endif %}
                    </th>
                    {% endfor %}
                    {% if user.id == 1 %}<th>Действие</th>{% endif %}
                </tr>
            </thead>

            <tbody>
                <tr>
                    <td style="background-color: #e0e0e0;"></td>
                    <td colspan="{{ metrics|length }}">
                        <!-- {{ latest_date or '-' }} -->
                        <form method="get" action="/">
                            <label>Выбрать дату:
                                <select name="date">
                                    {% for dt in available_dates %}
                                    <option value="{{ dt }}" {% if dt==selected_date %}selected{% endif %}>
                                        {{ dt }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </label>
                            <input type="submit" value="Показать">
                        </form>

                    </td>
                    {% if user.id == 1 %}
                    <td style="background-color: #e0e0e0;"></td>
                    {% endif %}
                </tr>

                {% if user.id == 1 %}
                <tr>
                    <td style="background-color: #e0e0e0;"></td>
                    {% for metric in metrics %}
                    <td>
                        {% if not loop.first %}
                        <form method="post" action="/delete_metric/{{ metric.id }}">
                            <input type="hidden" name="page" value="{{ page }}">
                            <input type="submit" value="Удалить" class="table-btn-del">
                        </form>
                        {% endif %}
                    </td>
                    {% endfor %}
                    <td style="background-color: #e0e0e0;"></td>
                </tr>
                {% endif %}

                {% for row in table_data %}
                <tr>
                    <td>{{ row.branch_name }}
                        <br>
                        {% if user.id in (1, 2) %}
                        <form method="post" action="/update_branch_id/{{ row.branch_id }}"
                            style="display:inline-block; margin-left:5px;">
                            <input type="number" name="new_id" value="{{ row.branch_id }}" style="width:50px;">
                            <input type="submit" value="Сохранить" class="table-btn">
                        </form>
                        {% endif %}
                    </td>
                    {% for metric_name, metric_data in row.metrics.items() %}
                    {% if user.can_edit == 1 and metric_name in editing %}
                    <td>
                        <form method="post" action="/update/{{ metric_data.id }}">
                            <input type="number" name="value" step="any" value="{{ metric_data.value }}">
                            <input type="hidden" name="branch_id" value="{{ row.branch_id }}">
                            <input type="hidden" name="metric_id" value="{{ metric_data.metric_id }}">
                            <input type="hidden" name="page" value="{{ page }}">
                            <br>
                            <input type="submit" value="Сохранить" class="table-btn">
                        </form>
                    </td>
                    {% else %}
                    <td>{{ metric_data.value }}</td>
                    {% endif %}
                    {% endfor %}

                    {% if user.id == 1 %}
                    <td>
                        <form method="post" action="/delete/{{ row.branch_id }}">
                            <input type="hidden" name="page" value="{{ page }}">
                            <input type="submit" value="Удалить" class="table-btn-del">
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}

                <tr style="font-weight: bold; background-color: #f0f0f0;">
                    <td>ИТОГО</td>
                    {% for metric in metrics %}
                    <td>{{ totals[metric.name] }}</td>
                    {% endfor %}
                    {% if user.id == 1 %}
                    <td></td>
                    {% endif %}
                </tr>
            </tbody>
        </table>
        <div class="pagination-form">
            {% if start_page > 1 %}
            <a href='/?page=1'>1</a>
            {% if start_page > 2 %}…{% endif %}
            {% endif %}

            {% for p in range(start_page, end_page + 1) %}
            {% if p == page %}
            <strong>{{ p }}</strong>
            {% else %}
            <a href='/?page={{ p }}'>{{ p }}</a>
            {% endif %}
            {% endfor %}

            {% if end_page < total_pages %} {% if end_page < total_pages - 1 %}…{% endif %} <a
                href='/?page={{ total_pages }}'>{{ total_pages }}</a>
                {% endif %}
        </div>
        {% if user.id == 1 %}
        <div class="add-forms-container">
            <div class="add-department-form">
                <h3>Добавить отдел</h3>
                <form method="post" action="/add">
                    <input type="text" name="name" placeholder="Название отдела" required>
                    <input type="submit" value="Добавить" class="table-btn">
                </form>
            </div>

            <div class="add-department-form">
                <h3>Добавить метрику</h3>
                <form method="post" action="/add_metric">
                    <input type="text" name="name" placeholder="Название метрики" required>
                    <input type="submit" value="Добавить" class="table-btn">
                </form>
            </div>
        </div>
        {% endif %}
        <div id="overlay"></div>
        <div id="save-msg">{{ msg }}</div>
    </div>

    <h3>Графики</h3>
    <div style="width: 80%; margin: auto;">
        <canvas id="chartFact" height="200"></canvas>
    </div>
    <div style="width: 80%; margin: auto; margin-top: 40px;">
        <canvas id="chartLeave" height="200"></canvas>
    </div>

</body>

<script src="/static/chart.js"></script>
<script>
    function toggleText(button) {
        const container = button.parentNode;
        const shortText = container.querySelector(".short-text");
        const fullText = container.querySelector(".full-text");

        if (fullText.style.display === "none") {
            fullText.style.display = "inline";
            shortText.style.display = "none";
            button.textContent = "Скрыть";
        } else {
            fullText.style.display = "none";
            shortText.style.display = "inline";
            button.textContent = "Показать";
        }
    }

    const chartData = JSON.parse('{{ chart_data | safe }}');

    const ctxFact = document.getElementById("chartFact").getContext("2d");
    new Chart(ctxFact, {
        type: "line",
        data: {
            labels: chartData.dates,
            datasets: [
                { label: "Фактически работающие", data: chartData.working, borderColor: "green", fill: false },
                { label: "Факт", data: chartData.fact, borderColor: "blue", fill: false },
                { label: "Штатная численность", data: chartData.staff, borderColor: "orange", fill: false }
            ]
        }
    });

    const ctxLeave = document.getElementById("chartLeave").getContext("2d");
    new Chart(ctxLeave, {
        type: "line",
        data: {
            labels: chartData.dates,
            datasets: [
                { label: "Больничные", data: chartData.sick, borderColor: "red", fill: false },
                { label: "Отпуск", data: chartData.vacation, borderColor: "purple", fill: false }
            ]
        }
    });

</script>
<script src="/static/script.js"></script>

</html>
