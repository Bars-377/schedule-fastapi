<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Таблица отделов</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <h2>Таблица отделов</h2>
    <p>Привет, {{ user.username }} | <a href='/logout'>Выйти</a></p>

    <div class="table-container">
        <table>
            <!-- Заголовок таблицы -->
            <tr>
                <th>Отдел ОГКУ "ТО МФЦ"</th>
                {% for metric in metrics %}
                    <th>{{ metric.name }}</th>
                {% endfor %}
                {% if user.id == 1 %}
                    <th>Действие</th>
                {% endif %}
            </tr>

            <!-- Дата последнего обновления -->
            <tr>
                <td style="background-color: #e0e0e0;"></td>
                <td colspan="{{ metrics|length + (1 if user.id == 1 else 0) }}">
                    {{ latest_date or '-' }}
                </td>
            </tr>

            <!-- Кнопки удаления метрик (только для admin) -->
            {% if user.id == 1 %}
            <tr>
                <td style="background-color: #e0e0e0;"></td>
                {% for metric in metrics %}
                    <td>
                        <form class="table-form" method="post" action="/delete_metric/{{ metric.id }}">
                            <input type="hidden" name="page" value="{{ page }}">
                            <input type="submit" value="Удалить" class="table-btn-del">
                        </form>
                    </td>
                {% endfor %}
                <td style="background-color: #e0e0e0;"></td>
            </tr>
            {% endif %}

            <!-- Данные филиалов -->
            {% for row in table_data %}
                <tr>
                    <td>{{ row.branch_name }}</td>
                    {% for metric_name, metric_data in row.metrics.items() %}
                        {% if user.can_edit == 1 and metric_name in ["Метрика1", "Метрика7"] %}
                            <td>
                                <form class="table-form" method="post" action="/update/{{ metric_data.id }}">
                                    <input type="number" name="value" step="any" value="{{ metric_data.value }}">
                                    <input type="hidden" name="branch_id" value="{{ row.branch_id }}">
                                    <input type="hidden" name="metric_id" value="{{ metric_data.metric_id }}">
                                    <input type="hidden" name="page" value="{{ page }}">
                                    <br>
                                    <input type="submit" value="Сохранить" class="table-btn">
                                </form>
                            </td>
                        {% else %}
                            <td>{{ metric_data.value }}</td>
                        {% endif %}
                    {% endfor %}
                    {% if user.id == 1 %}
                        <td>
                            <form class="table-form" method="post" action="/delete/{{ row.branch_id }}">
                                <input type="hidden" name="page" value="{{ page }}">
                                <input type="submit" value="Удалить" class="table-btn-del">
                            </form>
                        </td>
                    {% endif %}
                </tr>
            {% endfor %}

            <!-- Итоговая строка -->
            <tr style="font-weight: bold; background-color: #f0f0f0;">
                <td>ИТОГО</td>
                {% for metric in metrics %}
                    <td>{{ totals[metric.name] }}</td>
                {% endfor %}
                {% if user.id == 1 %}
                    <td></td>
                {% endif %}
            </tr>
        </table>
    </div>

    <!-- Пагинация -->
    <div class="pagination-form">
        {% if start_page > 1 %}
            <a href='/?page=1'>1</a>
            {% if start_page > 2 %}…{% endif %}
        {% endif %}
        {% for p in range(start_page, end_page + 1) %}
            {% if p == page %}
                <strong>{{ p }}</strong>
            {% else %}
                <a href='/?page={{ p }}'>{{ p }}</a>
            {% endif %}
        {% endfor %}
        {% if end_page < total_pages %}
            {% if end_page < total_pages - 1 %}…{% endif %}
            <a href='/?page={{ total_pages }}'>{{ total_pages }}</a>
        {% endif %}
    </div>

    <!-- Добавление отделов и метрик -->
    {% if user.id == 1 %}
    <div class="add-forms-container">
        <div class="add-department-form">
            <h3>Добавить отдел</h3>
            <form method="post" action="/add">
                <input type="text" name="name" placeholder="Название отдела" required>
                <input type="submit" value="Добавить" class="table-btn">
            </form>
        </div>

        <div class="add-department-form">
            <h3>Добавить метрику</h3>
            <form method="post" action="/add_metric">
                <input type="text" name="name" placeholder="Название метрики" required>
                <input type="submit" value="Добавить" class="table-btn">
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Оверлей и сообщение сохранения -->
    <div id="overlay" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9998;
    "></div>

    <div id="save-msg" style="
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 128, 0, 0.9);
        color: white;
        padding: 20px 40px;
        font-size: 24px;
        font-weight: bold;
        border-radius: 10px;
        z-index: 9999;
        box-shadow: 0 0 10px #000;
    ">
        {{ msg }}
    </div>

    <script>
        const hasMsg = {{ 'true' if msg else 'false' }};
    </script>
    <script src="/static/script.js"></script>
</body>
</html>
