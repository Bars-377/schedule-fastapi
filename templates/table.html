<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Таблица отделов</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h2>Таблица отделов</h2>
    <p>Привет, {{ user.username }} | <a href='/logout'>Выйти</a></p>

    <div class="table-container">
        <table>
            <tr>
                <th>Отдел</th>
                {% for metric in metrics %}
                    {% if loop.first %}
                        <th>{{ metric.name }} (ред.)</th>
                    {% else %}
                        <th>{{ metric.name }}</th>
                    {% endif %}
                {% endfor %}
                <th>Дата ред.</th>
                <th>Действие</th>
            </tr>

            {% for row in table_data %}
                <tr>
                    <td>{{ row.branch_name }}</td>
                    {% for metric_name, metric_data in row.metrics.items() %}
                        {% if user.can_edit == 1 and loop.index0 == 0 %}
                            <td>
                                <form class="table-form" method="post" action="/update/{{ metric_data.id }}">
                                    <input type="number" name="value" step="any" value="{{ metric_data.value }}">
                                    <input type="hidden" name="branch_id" value="{{ row.branch_id }}">
                                    <input type="hidden" name="metric_id" value="{{ metric_data.metric_id }}">
                                    <input type="hidden" name="page" value="{{ page }}">
                                    <br>
                                    <input type="submit" value="Сохранить">
                                </form>
                            </td>
                        {% else %}
                            <td>{{ metric_data.value }}</td>
                        {% endif %}
                    {% endfor %}

                    <td>
                        {% set first_metric = row.metrics|dictsort|first %}
                        {% if first_metric %}
                            {{ first_metric[1].record_date or '-' }}
                        {% else %}
                            -
                        {% endif %}
                    </td>

                    <td>
                        {% if user.can_edit == 1 %}
                            <form class="table-form" method="post" action="/delete/{{ row.branch_id }}">
                                <input type="hidden" name="page" value="{{ page }}">
                                <input type="submit" value="Удалить">
                            </form>
                        {% else %}
                            Нет прав
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>

    <div class="pagination-form">
        {% if start_page > 1 %}
            <a href='/?page=1'>1</a>
            {% if start_page > 2 %}…{% endif %}
        {% endif %}

        {% for p in range(start_page, end_page + 1) %}
            {% if p == page %}
                <strong>{{ p }}</strong>
            {% else %}
                <a href='/?page={{ p }}'>{{ p }}</a>
            {% endif %}
        {% endfor %}

        {% if end_page < total_pages %}
            {% if end_page < total_pages - 1 %}…{% endif %}
            <a href='/?page={{ total_pages }}'>{{ total_pages }}</a>
        {% endif %}
    </div>

    {% if user.can_edit == 1 %}
        <div class="add-department-form">
            <h3>Добавить отдел</h3>
            <form method="post" action="/add">
                <input type="text" name="name" placeholder="Название отдела" required>
                <input type="submit" value="Добавить">
            </form>
        </div>
    {% endif %}
</body>

<!-- Добавляем этот div прямо перед </body> -->
<div id="overlay" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9998;
"></div>

<div id="save-msg" style="
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 128, 0, 0.9);
    color: white;
    padding: 20px 40px;
    font-size: 24px;
    font-weight: bold;
    border-radius: 10px;
    z-index: 9999;
    box-shadow: 0 0 10px #000;
">
    {{ msg }}
</div>

<script>
    // Показываем сообщение и overlay, если есть msg
    {% if msg %}
        const overlay = document.getElementById('overlay');
        const saveMsg = document.getElementById('save-msg');

        overlay.style.display = 'block';
        saveMsg.style.display = 'block';

        setTimeout(() => {
            saveMsg.style.display = 'none';
            overlay.style.display = 'none';
        }, 1500); // 1.5 секунды
    {% endif %}

    // Убираем msg из URL и со страницы
    setTimeout(() => {
        const url = new URL(window.location.href);
        if (url.searchParams.has('msg')) {
            url.searchParams.delete('msg');
            history.replaceState(null, '', url.pathname + (url.searchParams.toString() ? '?' + url.searchParams.toString() : ''));
        }

        const msg = document.querySelector('.msg-green');
        if (msg) msg.remove();
    }, 1500);

    // Функция сохраняет текущую позицию скролла перед отправкой формы
    function saveScrollPosition() {
        localStorage.setItem('scrollPos', window.scrollY);
    }

    // На все формы в таблице вешаем событие перед отправкой
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', saveScrollPosition);
    });

    // После загрузки страницы восстанавливаем скролл
    window.addEventListener('load', () => {
        const scrollPos = localStorage.getItem('scrollPos');
        if (scrollPos) {
            window.scrollTo(0, parseInt(scrollPos));
            localStorage.removeItem('scrollPos'); // чтобы при следующей загрузке не скроллило
        }
    });

</script>

</html>
